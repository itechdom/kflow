(()=>{"use strict";var X={377:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(252),{executeDomain:y}=t(447),d=function({Model:n,crudDomainLogic:{create:A,read:f,update:l,del:r,search:c}}){const u=E.Router();return u.get("/",async(o,s)=>{try{const{criteria:i,isPermitted:a,populate:v,onResponse:m,exclude:P}=y(o,s,f),R=i?i.query:{};if(!a)return s.status(409).send({message:`You are not authorized to read ${n.modelName}s`});const z=P?P.map(U=>`-${U}`).join(" "):"",L=await n.find(R).sort("-createdAt").populate(Array.isArray(v)?v.join(" "):"").select(z).exec();m?m({data:L,count:L.length},o,s):s.status(200).send({data:L,count:L.length})}catch(i){s.status(500).send({message:`Database connection error: ${i.message}`})}}),u.get("/paginate/:page/:limit",async(o,s)=>{try{const{criteria:i,isPermitted:a,populate:v,onResponse:m,exclude:P}=y(o,s,f),{query:R}=i,{page:z,limit:L}=o.params;if(!a)return s.status(409).send({message:`You are not authorized to read ${n.modelName}s`});const U=P?P.map(W=>`-${W}`).join(" "):"",S=await n.countDocuments(R).exec(),B=await n.paginate(R,{page:parseInt(z),limit:parseInt(L),select:U,sort:"-createdAt"});m?m({data:B.docs,count:S},o,s):s.status(200).send({data:B.docs,count:S})}catch(i){s.status(500).send({message:`Database connection error: ${i.message}`})}}),u.post("/create",async(o,s)=>{try{const{isPermitted:i,onResponse:a}=y(o,s,A),v=new n(o.body.model);if(n.joiValidate){const{error:m}=n.joiValidate(v);if(m)return s.status(409).send({message:`Error validating your input ${m}`})}if(!i)return s.status(409).send({message:`You are not authorized to create this ${n.modelName}`});await v.save(),a?a(v,o,s):s.status(200).send(v)}catch(i){s.status(500).send({message:`Database connection error: ${i.message}`})}}),u.put("/",async(o,s)=>{try{const{criteria:i,isPermitted:a,onResponse:v}=y(o,s,l);if(!a)return s.status(409).send({message:`You are not authorized to update this ${n.modelName}`});const m=Object.assign({},o.body.model);if(n.joiValidate){const{error:R}=n.joiValidate(m);if(R)return s.status(409).send({message:`Error validating your input ${R}`})}const P=await n.findOneAndUpdate({_id:m._id,...i},m,{new:!0,upsert:!1}).exec();v?v(P,o,s):s.status(200).send(P)}catch(i){s.status(500).send({message:`Database connection error: ${i.message}`})}}),u.delete("/:_id",async(o,s)=>{try{const i=o.params._id,{criteria:a,isPermitted:v}=y(o,s,r);if(!v)return s.status(409).send({message:`You are not authorized to delete this ${n.modelName}`});await n.deleteOne({_id:i,...a}).exec(),s.status(200).send()}catch(i){s.status(500).send({message:`Database connection error: ${i.message}`})}}),u.post("/search",async(o,s)=>{try{const i=o.body.query,{criteria:a,isPermitted:v,onResponse:m}=y(o,s,c);if(!v)return s.status(409).send({message:`You are not authorized to search ${n.modelName}s`});const P=await n.find({...i,...a}).exec();m?m(P,o,s):s.status(200).send(P)}catch(i){s.status(500).send({message:`Database connection error: ${i.message}`})}}),u};e.exports=d},363:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(252),y=t(938),d=function(n){var A=E.Router();const f=process.env.OPEN_AI_KEY;return A.post("/chat",async(l,r)=>{const{prompt:c}=l.body;if(!c)return r.status(400).send({message:"Prompt is required"});try{const o=await y.post("https://api.openai.com/v1/chat/completions",{model:"gpt-4o",messages:[{role:"user",content:c}]},{headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"}});r.status(200).send(o.data)}catch(o){var u;console.error("Error calling OpenAI API:",((u=o.response)===null||u===void 0?void 0:u.data)||o.message),r.status(500).send({message:"Failed to fetch response from OpenAI"})}}),A.post("/image",async(l,r)=>{const{prompt:c}=l.body;if(!c)return r.status(400).send({message:"Prompt is required for image generation"});try{const o=await y.post("https://api.openai.com/v1/images/generations",{model:"dall-e-2",prompt:c,n:1,size:"256x256"},{headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"}});r.status(200).send(o.data)}catch(o){var u;console.error("Error calling OpenAI API for images:",((u=o.response)===null||u===void 0?void 0:u.data)||o.message),r.status(500).send({message:"Failed to fetch images from OpenAI"})}}),A};e.exports=d},447:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(896),y=t(928);e.exports.executeDomain=(d,n,A)=>{let f=d.decoded;return f||console.error(`${d.url} User doesn't exist in domain execute function make sure you have jwt protected routes and try again.`),A(f,d,n)},e.exports.parseNumberQuery=d=>(Object.keys(d).map(n=>{parseInt(d[n]&&d[n]!==0)&&(d[n]=parseInt(d[n]))}),d),e.exports.capitalize=function(d){return d.charAt(0).toUpperCase()+d.slice(1)},e.exports.readFiles=function(d,n,A){E.readdir(y.join(__dirname,d),function(f,l){if(f){A(f);return}l.forEach(function(r){E.readFile(y.join(__dirname,d)+r,"utf-8",function(c,u){if(c){A(c);return}n(r,u)})})})}},48:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(252),y=t(611),d=t(37),n=t(268),A=t(96),f=t(726),l=t(977),r=t(785),c=t(847),u=t(310),o=d.model("Permissions",u),s=t(807),i=t(165),a=t(478),v=d.model("Notification",a),m=d.model("Forms",i),P=t(169),R=t(123),z=t(928),L=t(577),{connectToDb:U}=t(664),S=async(p,h)=>{const D=E();if(D.set("superSecret",p.secret),!h){const I=p.get("server.port"),C=p.get("server.host");var $=y.createServer(D);$.listen(I),console.log(`Magic happens at ${C}:${I}`)}const T=p.get("cors.whitelist"),j={origin:function(I,C){if(console.warn("SHALL YOU PASS?",I,T),!I)return C(null,!1);T.find(N=>I.indexOf(N)!==-1)?(console.warn("YOU SHALL PASS",I),C(null,!0)):C(null,!1)},credentials:!0,exposedHeaders:["Content-Length","X-Foo","X-Bar"]};return D.use(l({secret:"thecatwentoverthefencebutfoundafoxsosheranaway",saveUninitialized:!0,resave:!0})),D.options("*",L(j)),D.use(L(j)),D.use(function(I,C,N){C.header("Access-Control-Allow-Origin","*"),C.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE"),C.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),N()}),D.use(n.urlencoded({extended:!1})),D.use(n.json({limit:"50mb",type:"application/json"})),D.use(A("dev")),{server:$,app:D}},B=({server:p,app:h,exceptions:{disableChat:D,disableRides:$}})=>{const T={permissionsModel:o,formsModel:m,settingsModel:c,kernelModel:s,notificationsModel:v,userModel:r,config:f},{knowledgeApiRoutes:j}=P({...T});return{knowledgeApiRoutes:j,...T}},W=async({app:p,server:h,exceptions:D,authApiRoutes:$,userApiRoutes:T,jwtApiRoutes:j,aclApiRoutes:I,formsApiRoutes:C,settingsApiRoutes:N,kernelApiRoutes:Q,notificationsApiRoutes:J,knowledgeApiRoutes:G,ridesApiRoutes:Z,mediaApiRoutes:w,...q})=>{p.use("/knowledge",...G)},V=p=>{let h=z.join(__dirname,"./docs/routes.md");R(p,h)},x=async({exceptions:p})=>{const{app:h,server:D}=await S(f);await U(j=>console.log("connected to db"+j));const{knowledgeApiRoutes:$,...T}=B({app:h,server:D,exceptions:p});return await W({app:h,server:D,exceptions:p,knowledgeApiRoutes:$,...T}),{app:h,exceptions:p}};e.exports=x,e.exports.getAllApis=B,e.exports.registerAllRoutes=W,e.exports.getExpressApp=S},130:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(377),y=t(633),d=t(541),n=t(363),{formsService:A,registerForms:f}=t(605),{registerAction:l,isPermitted:r}=t(485),c=({config:u,knowledgeModel:o,permissionsModel:s,lambdaModel:i,formsModel:a,autoPopulateDB:v=!1})=>{let m="knowledges",P={create:(x,p)=>({isPermitted:r({key:`${m}_create`,user:x}),criteria:{}}),read:(x,p)=>{const h=p.query&&p.query.query;return{isPermitted:r({key:`${m}_read`,user:x}),criteria:{query:h},exclude:h&&h._id?[]:["body"]}},update:(x,p)=>({isPermitted:r({key:`${m}_update`,user:x}),criteria:{}}),del:(x,p)=>({isPermitted:r({key:`${m}_delete`,user:x}),criteria:{}}),search:(x,p)=>({isPermitted:r({key:`${m}_search`,user:x}),criteria:{},onResponse:(h,D,$)=>{let T=h.map(j=>({_id:j._id,title:j.title}));return $.status(200).send({data:T,count:T.length})}})};const R=E({Model:o,crudDomainLogic:P}),L=d({Model:o,domainLogic:{average:(x,p,h)=>({}),min:(x,p,h)=>({}),max:(x,p,h)=>({}),sum:(x,p,h)=>({}),count:(x,p,h)=>({}),distinct:(x,p,h)=>({})}}),U=n(u);let S={getMedia:(x,p,h)=>({criteria:{tag:x._id,token:x.jwtToken,query:{_id:p.query.query}},isPermitted:!0}),saveMedia:(x,p,h)=>({criteria:{token:x.jwtToken,query:{_id:p.query.query,fileName:p.query.fileName}},isPermitted:!0})};const B=y({fileName:"knowledges",modelName:m,mediaDomainLogic:S,Model:o,fileExtension:".jpg"}),V=A({Model:a,formsDomainLogic:{read:x=>({criteria:{key:`${m}`},isPermitted:!0})}});return v&&(l({key:`${m}`,domainLogic:P,permissionsModel:s,defaultPermission:!1}),l({key:`${m}`,domainLogic:S,permissionsModel:s}),f({key:`${m}`,fields:[{type:"text",name:"title",placeholder:"Knowledge Title",value:"",required:!0},{type:"array",name:"tags",placeholder:"Tags",value:[],required:!1}],formsModel:a})),[R,B,L,V,U]};e.exports=c},169:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(503),y=t(130),d=t(553),n=t(37),A=({config:f,userModel:l,settingsModel:r,formsModel:c,permissionsModel:u,kernelModel:o,notificationsModel:s})=>{const i=n.model("knowledges",E);return{knowledgeApiRoutes:y({config:f,knowledgeModel:i,...{kernelModel:o,permissionsModel:u,settingsModel:r,formsModel:c,notificationsModel:s,lambdaModel:d}})}};e.exports=A},664:(e,g,t)=>{t.r(g);var M=t(880),K=t.n(M);e=t.hmd(e);const E=t(622),y=t(726),d=t(896),{v4:n}=t(903),A=t(928);e.exports.readFiles=function(l,r,c){return d.readdir(A.join(__dirname,l),function(u,o){if(u){c(u);return}o.forEach(function(s){d.readFile(A.join(__dirname,l)+s,"utf-8",function(i,a){if(i){c(i);return}r(s,a)})})})},e.exports.connectToDb=async function(l){return await E({config:y,onDBInit:c=>l(null,c),onError:c=>l("err",c),onDisconnect:c=>l("disconnect",c)})},e.exports.formatMindmap=function f(l,r){l&&Object.keys(l).map((c,u)=>{let o=r?r+`.${u}`:"0";return l[c].level=o,l[c]._id=n(),f(l[c].ideas,o)})},e.exports.flattenMindmap=function f(l,r,c){if(l){let u=r&&parseInt(r.level.split(".").join("")),o=20/(r&&r.level.split(".").length);Object.keys(l).map((s,i)=>{let a=l[s];const{title:v}=a;c[a._id]={title:v,id:a._id,_id:a._id,size:o,group:u,level:a.level,attr:a.attr&&a.attr.note&&a.attr.note.text,children:a.ideas?Object.keys(a.ideas).map(m=>a.ideas[m]._id):[],parent:r&&r._id,links:{title:r&&r.title,target:a._id,source:r&&r._id||a._id,group:u}},f(a.ideas,a,c)})}}},485:e=>{e.exports=require("@markab.io/node/acl-service/acl-service")},605:e=>{e.exports=require("@markab.io/node/forms-service/forms-service")},633:e=>{e.exports=require("@markab.io/node/media-service/media-service")},541:e=>{e.exports=require("@markab.io/node/viz-service/viz-service")},622:e=>{e.exports=require("@markab.io/orbital-api/MongoDb")},165:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/forms")},807:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/kernel")},503:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/knowledges")},553:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/lambda")},478:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/notifications")},310:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/permissions")},847:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/settings")},785:e=>{e.exports=require("@markab.io/orbital-api/MongoDb/models/user")},938:e=>{e.exports=require("axios")},268:e=>{e.exports=require("body-parser")},726:e=>{e.exports=require("config")},577:e=>{e.exports=require("cors")},252:e=>{e.exports=require("express")},123:e=>{e.exports=require("express-print-routes")},977:e=>{e.exports=require("express-session")},37:e=>{e.exports=require("mongoose")},96:e=>{e.exports=require("morgan")},880:e=>{e.exports=require("source-map-support/register")},903:e=>{e.exports=require("uuid")},896:e=>{e.exports=require("fs")},611:e=>{e.exports=require("http")},928:e=>{e.exports=require("path")}},F={};function O(e){var g=F[e];if(g!==void 0)return g.exports;var t=F[e]={id:e,loaded:!1,exports:{}};return X[e](t,t.exports,O),t.loaded=!0,t.exports}O.n=e=>{var g=e&&e.__esModule?()=>e.default:()=>e;return O.d(g,{a:g}),g},O.d=(e,g)=>{for(var t in g)O.o(g,t)&&!O.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:g[t]})},O.hmd=e=>(e=Object.create(e),e.children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),O.o=(e,g)=>Object.prototype.hasOwnProperty.call(e,g),O.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var b={};(()=>{O.r(b);var e=O(880),g=O.n(e);O(48)({exceptions:{}})})();var Y=exports;for(var H in b)Y[H]=b[H];b.__esModule&&Object.defineProperty(Y,"__esModule",{value:!0})})();

//# sourceMappingURL=index.js.map